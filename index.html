<!DOCTYPE html>
<html>
<head>
    <title>qib13</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background-color: #f5f5f5; }
        .container { display: flex; flex-direction: column; gap: 20px; }
        .section { border: 1px solid #ddd; padding: 20px; border-radius: 8px; background-color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1, h2 { color: #333; }
        textarea, input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; }
        textarea { height: 100px; }
        button { padding: 12px 20px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin-right: 10px; }
        button:hover { background: #45a049; }
        button:disabled { background: #cccccc; cursor: not-allowed; }
        .result, .seed-display, .attempt-log { background: #f9f9f9; padding: 10px; border-radius: 4px; word-break: break-all; margin-top: 10px; font-family: monospace; font-size: 12px; }
        .error { color: #d32f2f; font-weight: bold; }
        .success { color: #388e3c; font-weight: bold; }
        .warning { color: #f57c00; font-weight: bold; }
        .copy-button { background: #2196F3; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-left: 10px; }
        .copy-button:hover { background: #0b7dda; }
        .comparison-table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        .comparison-table th, .comparison-table td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
        .comparison-table th { background-color: #f5f5f5; }
        .mode-selector { margin: 15px 0; }
        .mode-selector label { margin-right: 20px; }
        .mode-selector input { margin-right: 5px; }
        .system-config { background-color: #f3e5f5; padding: 15px; border-radius: 8px; margin: 15px 0; }
        .progress-bar { width: 100%; height: 20px; background-color: #e0e0e0; border-radius: 10px; margin: 10px 0; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #4CAF50, #8BC34A); transition: width 0.3s ease; }
        .tab-container { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 15px; }
        .tab { padding: 10px 20px; cursor: pointer; background-color: #f5f5f5; border: 1px solid #ddd; border-bottom: none; border-radius: 5px 5px 0 0; margin-right: 5px; }
        .tab.active { background-color: white; border-bottom: 1px solid white; margin-bottom: -1px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body>
    <div class="container">
        <h1>qib13</h1>
        <div class="tab-container">
            <div class="tab active" onclick="switchTab('generate')">Generate Systems</div>
            <div class="tab" onclick="switchTab('encode')">Generate Seed</div>
            <div class="tab" onclick="switchTab('recover')">Recover Code</div>
            <div class="tab" onclick="switchTab('test')">Batch Test</div>
        </div>
        
        <!-- Generate Systems -->
        <div id="generate-tab" class="tab-content active">
            <div class="section">
                <h2>Generate Reproducible Systems</h2>
                <div class="system-config">
                    <label for="masterSeed">Master Seed:</label>
                    <input type="text" id="masterSeed" placeholder="Enter your master seed">
                    <label for="numSystems">Number of Deviation Systems (N):</label>
                    <input type="number" id="numSystems" min="1" max="100" value="10">
                    <button onclick="generateSystems()">Generate Systems</button>
                    <button onclick="useDefaultSystems()" class="secondary-button">Use Default Systems</button>
                </div>
                <div id="systemStatus" class="info"></div>
            </div>
        </div>

        <!-- Generate Seed -->
        <div id="encode-tab" class="tab-content">
            <div class="section">
                <h2>Generate Seed from Generator Code</h2>
                <input type="text" id="generatorCodeInput" maxlength="13" placeholder="Enter 13-letter generator code (a-z)">
                <div class="mode-selector">
                    <label><input type="radio" name="generateMode" value="original" checked> Original Mode (System 1)</label>
                    <label><input type="radio" name="generateMode" value="deviation"> Deviation Mode (System 2)</label>
                    <label><input type="radio" name="generateMode" value="random"> Random System</label>
                    <label><input type="radio" name="generateMode" value="specific"> Specific System</label>
                </div>
                <div id="generateSpecificSystemInput" style="display: none; margin: 10px 0;">
                    <label for="generateSpecificSystemIndex">System Index (1-N):</label>
                    <input type="number" id="generateSpecificSystemIndex" min="1" max="10" value="1">
                </div>
                <button onclick="generateSeed()">Generate 55-Letter Seed</button>
                <div id="generateResult" class="result"></div>
            </div>
        </div>

        <!-- Recover Code -->
        <div id="recover-tab" class="tab-content">
            <div class="section">
                <h2>Recover Generator Code from Seed</h2>
                <input type="text" id="seedInput" maxlength="55" placeholder="Enter 55-letter seed (a-z)">
                <div class="mode-selector">
                    <label><input type="radio" name="recoverMode" value="sequential" checked> Sequential Recovery (Try All Systems)</label>
                    <label><input type="radio" name="recoverMode" value="original"> Try Original Only</label>
                    <label><input type="radio" name="recoverMode" value="specific"> Try Specific System</label>
                </div>
                <div id="specificSystemInput" style="display: none; margin: 10px 0;">
                    <label for="specificSystemIndex">System Index (1-N):</label>
                    <input type="number" id="specificSystemIndex" min="1" max="10" value="1">
                </div>
                <button onclick="recoverGeneratorCode()">Recover Generator Code</button>
                <div id="recoverResult" class="result"></div>
            </div>
        </div>

        <!-- Batch Test -->
        <div id="test-tab" class="tab-content">
            <div class="section">
                <h2>Batch Recovery Test</h2>
                <div class="button-group">
                    <button onclick="runBatchTest()">Run Batch Test</button>
                    <button onclick="clearBatchResults()" class="secondary-button">Clear Results</button>
                </div>
                <div id="batchResult" class="result"></div>
            </div>
        </div>
    </div>

<script>
/* ================= Secure xoshiro256** PRNG ================= */
class Xoshiro256StarStar {
    constructor(seedArray) {
        if (!seedArray || seedArray.length !== 8) {
            throw new Error("Seed array must be 8 32-bit integers (256-bit total)");
        }
        // split 256-bit seed into 4 x 64-bit state
        this.state = [
            (BigInt(seedArray[0]) << 32n) | BigInt(seedArray[1]),
            (BigInt(seedArray[2]) << 32n) | BigInt(seedArray[3]),
            (BigInt(seedArray[4]) << 32n) | BigInt(seedArray[5]),
            (BigInt(seedArray[6]) << 32n) | BigInt(seedArray[7])
        ];
    }

    rotl(x, k) {
        return ((x << BigInt(k)) | (x >> BigInt(64 - k))) & 0xFFFFFFFFFFFFFFFFn;
    }

    next() {
        const result = this.rotl(this.state[1] * 5n, 7) * 9n;
        const t = this.state[1] << 17n;

        this.state[2] ^= this.state[0];
        this.state[3] ^= this.state[1];
        this.state[1] ^= this.state[2];
        this.state[0] ^= this.state[3];
        this.state[2] ^= t;
        this.state[3] = this.rotl(this.state[3], 45);

        return Number(result & 0xFFFFFFFFn) >>> 0; // return 32-bit unsigned
    }

    nextInt(min, max) {
        const val = this.next();
        return min + (val % (max - min));
    }
}

// Convert string seed to 256-bit array using SHA-256
async function seedToArray(seedStr) {
    const encoder = new TextEncoder();
    const hashBuffer = await crypto.subtle.digest('SHA-256', encoder.encode(seedStr));
    const view = new DataView(hashBuffer);
    const arr = [];
    for (let i = 0; i < 32; i += 4) {
        arr.push(view.getUint32(i, false));
    }
    return arr.concat(arr); // make 8 elements (256-bit)
}

/* ================= Encoding System ================= */
class EncodingSystem {
    constructor(id, type, matrices, permutation, inversePermutation) {
        this.id = id;
        this.type = type;
        this.matrices = matrices;
        this.permutation = permutation;
        this.inversePermutation = inversePermutation;
    }

    lettersToNumbers(letters) {
        return Array.from(letters).map(c => c.charCodeAt(0) - 97);
    }

    numbersToLetters(numbers) {
        return numbers.map(n => String.fromCharCode(n + 97)).join('');
    }

    matrixVectorMultiplyMod26(matrix, vector) {
        return matrix.map(row => row.reduce((acc, val, i) => acc + val * vector[i], 0) % 26);
    }

    applyPermutation(vector, perm) {
        return perm.map(i => vector[i]);
    }

    generateSeed(generatorCode) {
        if (!/^[a-z]{13}$/.test(generatorCode)) throw new Error("Generator code must be 13 letters");
        const msg = this.lettersToNumbers(generatorCode);

        if (this.type === "original") {
            const parity = this.matrixVectorMultiplyMod26(this.matrices.P, msg);
            const neg = parity.map(x => (-x + 26) % 26);
            const codeword = this.applyPermutation(msg.concat(neg), this.permutation);
            return this.numbersToLetters(codeword);
        } else { // deviation
            const parity1 = this.matrixVectorMultiplyMod26(this.matrices.P1, msg).map(x => (-x + 26) % 26);
            const parity2 = this.matrixVectorMultiplyMod26(this.matrices.P2, msg).map(x => (-x + 26) % 26);
            const codeword = this.applyPermutation(msg.concat(parity1, parity2), this.permutation);
            return this.numbersToLetters(codeword);
        }
    }

    recoverGeneratorCode(seed) {
        if (!/^[a-z]{55}$/.test(seed)) throw new Error("Seed must be 55 letters");
        const codeword = this.applyPermutation(this.lettersToNumbers(seed), this.inversePermutation);
        const msg = codeword.slice(0,13);
        if (this.type==="original") {
            const parity = codeword.slice(13,55);
            const exp = this.matrixVectorMultiplyMod26(this.matrices.P, msg).map(x => (-x+26)%26);
            if (!exp.every((v,i)=>v===parity[i])) throw new Error("Invalid seed for original mode");
        } else {
            const p1 = codeword.slice(13,28);
            const p2 = codeword.slice(28,55);
            const exp1 = this.matrixVectorMultiplyMod26(this.matrices.P1, msg).map(x => (-x+26)%26);
            const exp2 = this.matrixVectorMultiplyMod26(this.matrices.P2, msg).map(x => (-x+26)%26);
            if (!exp1.every((v,i)=>v===p1[i])) throw new Error("Deviation parity1 failed");
            if (!exp2.every((v,i)=>v===p2[i])) throw new Error("Deviation parity2 failed");
        }
        return this.numbersToLetters(msg);
    }
}

/* ================= Global Variables ================= */
let allSystems = [];
let currentMasterSeed = "default_secure_seed_xxx";
let currentNumSystems = 10;

/* ================= Utility Functions ================= */
async function generateRandomMatrix(rows, cols, rng) {
    const matrix = [];
    for(let i=0;i<rows;i++){
        const row=[];
        for(let j=0;j<cols;j++){
            row.push(rng.nextInt(0,26));
        }
        matrix.push(row);
    }
    return matrix;
}

async function generateRandomPermutation(n, rng){
    const perm = Array.from({length:n},(_,i)=>i);
    for(let i=n-1;i>0;i--){
        const j = rng.nextInt(0,i+1);
        [perm[i],perm[j]]=[perm[j],perm[i]];
    }
    return perm;
}

function generateInversePermutation(perm){
    const inv = new Array(perm.length);
    perm.forEach((v,i)=>inv[v]=i);
    return inv;
}

async function createOriginalSystem(id, seedStr){
    const seedArray = await seedToArray(seedStr+"-original-"+id);
    const rng = new Xoshiro256StarStar(seedArray);
    const matrixP = await generateRandomMatrix(42,13,rng);
    const permutation = await generateRandomPermutation(55,rng);
    const inversePermutation = generateInversePermutation(permutation);
    return new EncodingSystem(id,"original",{P:matrixP},permutation,inversePermutation);
}

async function createDeviationSystem(id, seedStr){
    const seedArray = await seedToArray(seedStr+"-deviation-"+id);
    const rng = new Xoshiro256StarStar(seedArray);
    const P1 = await generateRandomMatrix(15,13,rng);
    const P2 = await generateRandomMatrix(27,13,rng);
    const permutation = await generateRandomPermutation(55,rng);
    const inversePermutation = generateInversePermutation(permutation);
    return new EncodingSystem(id,"deviation",{P1,P2},permutation,inversePermutation);
}

/* ================= Tab Functions ================= */
function switchTab(tabName){
    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.getElementById(tabName+'-tab').classList.add('active');
    event.target.classList.add('active');
}

function getSelectedMode(prefix){
    return Array.from(document.getElementsByName(prefix+'Mode')).find(r=>r.checked)?.value || 'original';
}

/* ================= Main Functions ================= */
async function generateSystems(){
    let masterSeed = document.getElementById('masterSeed').value.trim() || currentMasterSeed;
    let numSystems = parseInt(document.getElementById('numSystems').value) || 10;
    currentMasterSeed = masterSeed;
    currentNumSystems = numSystems;
    allSystems=[];

    const original = await createOriginalSystem(1, masterSeed);
    allSystems.push(original);
    for(let i=2;i<=numSystems+1;i++){
        const dev = await createDeviationSystem(i, masterSeed);
        allSystems.push(dev);
    }

    document.getElementById('systemStatus').innerHTML=`<div class="success"><strong>Systems Generated!</strong> Total: ${allSystems.length}</div>`;
}

async function useDefaultSystems(){
    document.getElementById('masterSeed').value=currentMasterSeed;
    document.getElementById('numSystems').value=currentNumSystems;
    await generateSystems();
}

function generateRandomGeneratorCode(){
    return Array.from({length:13},()=>String.fromCharCode(97+Math.floor(Math.random()*26))).join('');
}

function copyToClipboard(text){
    const ta = document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select();
    document.execCommand('copy'); document.body.removeChild(ta);
    const btn = event.target; const txt=btn.textContent; btn.textContent='Copied!'; setTimeout(()=>btn.textContent=txt,2000);
}

/* ================= Event Listeners ================= */
window.onload = async function(){
    await useDefaultSystems();

    document.getElementsByName('recoverMode').forEach(r=>{
        r.addEventListener('change',()=>{
            document.getElementById('specificSystemInput').style.display=(r.value==='specific')?'block':'none';
        });
    });
    document.getElementsByName('generateMode').forEach(r=>{
        r.addEventListener('change',()=>{
            document.getElementById('generateSpecificSystemInput').style.display=(r.value==='specific')?'block':'none';
        });
    });
};
</script>
</body>
</html>
